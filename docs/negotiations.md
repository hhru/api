Переписка (отклики/приглашения)
=====================

> В данный момент функциональность откликов/приглашений реализована только для соискателей.
 Для работодателей данный сервис запланирован, но еще не выпущен. 

В процессе использования сайта соискатели выбирают вакансии. 
Для того чтобы связаться с работодателем на предмет трудоустройства соискатель может откликнуться на выбранную вакансию.
Так же и работодатель, найдя интересное резюме, может предложить соискателю рассмотреть вакансию (приглашение). 

Для указанных целей служат специальные сущности — отклики/приглашения. 
В них может быть указана вакансия, резюме и переписка соискателя с работодателем, в каждый момент времени такие сущности находятся в одном из состояний.
Переход между состояниями сопровождается появлением сообщений с опциональным текстовым описанием и прочими полями.
Сообщения со статусом `null` не переводят весь отклик в новое состояние.

* [Получение списка откликов](#get_negotiations)
* [Получение списка активных откликов](#get_negotiations_active)
* [Откликнуться на вакансию](#post_negotiation)
* [Просмотр отклика/приглашения](#get_negotiation)
* [Отправка нового сообщения](#send_message)
* [Скрыть отклик](#hide_message)
* [Просмотр списка сообщений в отклике](#get_messages)
* [Редактирование сообщения в отклике](#edit_message)

<a name="get_negotiations"/> 
## Получение списка откликов
### Запрос 

```
GET /negotiations
```

Параметры:

 Имя | Обязательный | Описание
 --- | --- | ---
 page | нет | Номер страницы, по умолчанию: 0
 per_page | нет  | Количество выдаваемых элементов на страницу, по умолчанию 20. 
 order_by | нет  | Поле, по которому проводить сортировку выдаваемых данных. Возможные значения: `updated_at`, `created_at`. По умолчанию: `updated_at`
 order | нет | Направление сортировки. Возможные значения: `asc`, `desc`. По умолчанию: `desc`
 vacancy_id | нет | фильтр по id вакансии

### Ответ

```javascript
{ 
    "found": 1,
    "pages": 1,
    "per_page": 20,
    "page": 0,
    "items": [
        {
            "id": "123",
            "state": {
                "id": "invitation",
                "name": "Приглашение"
            },
            "hidden": false,
            "created_at": "2013-10-05T19:51:38+0400",
            "updated_at": "2013-10-07T18:30:57+0400",
            "url": "https://api.hh.ru/negotiations/123",
            "resume": {},
            "vacancy": {},
            "has_new_messsages": true,
            "read": true
        }
        // , .....
    ]
}
```

где: 

 Имя | Тип | Описание 
 --- | --- | --- 
 found | число | Количество найденных откликов ( ≥ 0 )
 pages | число | Количество страниц с откликами ( ≥ 1 )
 per_page | число | Количество элементов на страницу ( > 0 )
 page | число | Номер текущей страницы ( ≥ 0 )
 
В элементе `items` содержатся данные о откликах:

 Имя | Тип | Описание
 --- | --- | --- 
 id | строка | Идентификатор отклика
 state | объект | Текущее состояние отклика. Разрешенные значения находятся в справочнике [/dictionaries] (./dictionaries.md) в разделе ```negotiations_state``` 
 hidden | логический | Скрыт ли текущий отклик (True - отклик скрыт, False - отклик активен)
 created_at | строка | Дата и время создания отклика
 updated_at | строка | Дата и время последнего обновления отклика
 url | строка | Ссылка на полную версию отклика
 resume | объект, null | [Короткое представление резюме] (resumes.md#resume-nano)
 vacancy | объект, null | [Короткое представление вакансии] (vacancies.md#nano)
 has_new_messages | логический | Есть ли в отклике новые сообщения

В объекте вакансии ключи `url` и `alternate_url` могут быть `null`, если вакансия недоступна (удалена).

<a name="get_negotiations_active"/> 
## Получение списка активных откликов

### Запрос

```
GET /negotiations/active
```

Опциональные параметры и ответ такие же, как и в [списке откликов] (#get_negotiations)


<a name="post_negotiation"/> 
## Откликнуться на вакансию

Для того чтобы узнать, какими резюме возможно откликнуться на конкретную вакансию, можно воспользоваться 
[списком подходящих резюме] (suitable_resumes.md).

### Запрос

```
POST /negotiations
```
Параметры

 Имя | Обязательный | Описание
  --- | --- | ---
 vacancy_id | да | Идентификатор вакансии, на которую происходит отклик
 resume_id | да | Идентификатор резюме, которым производится отклик
 message | да | Сопроводительное письмо к отклику. Является обязательным, если в вакансии указано, что обязательно сопроводительное письмо

### Ответ
В случае успеха приходит HTTP-статус `201 Created`, а в заголовке `Location` ответа будет содержаться ссылка на созданный отклик (кроме `direct` вакансий, см. ниже)
```
HTTP/1.1 201 Created
...
Location: /negotiations/123
...
```
Для вакансий у которых тип `direct` ответ будет приходить с кодом `303 See Other`. 
```
HTTP/1.1 303 See Other
...
Location: http://example.com/respond/vacancy
...
```
Вакансии с типом `direct` – это вакансии с прямым откликом. У данных вакансий непустой `response_url` – внешний url на сайт работодателя, который отдается в заголовке `Location` при попытке откликнуться. Используйте `response_url`, чтобы предложить пользователю откликнуться на вакансию на сайте работодателя вместо стандартного механизма откликов.

Если указанные вакансия или резюме не существуют, либо для отклика необходимо
пройти тест или заполнить сопроводительное письмо будет приходить ответ с кодом
`400 Bad Request`. Если на указанную вакансию не возможно откликнуться, по
причине отсутствия доступа к ней или из-за того, что уже был отклик ранее -
`403 Forbidden`. Если настройки видимости выбранного резюме не позволяют
откликнуться на вакансию – `403 Forbidden`

Если отклик на указанную вакансию не возможен, будет приходить ответ с кодом
`400 Bad Request`. Например, такое может произойти, если работодатель закрыл
возможность присылать отклики на вакансию.

Если количество откликов в день для пользователя превышено будет приходить ответ
с кодом `400 Bad Request`.

<a name="get_negotiation" />
## Просмотр отклика/приглашения

### Запрос
```
GET /negotiations/{nid}
```
где nid - идентификатор отклика.

### Ответ

Возвращаемый объект полностью идентичен отдельному отклику, получаемому в [списке откликов](#get_negotiations), за исключением поля `messaging_status`.

 Имя | Тип | Описание 
 --- | --- | ---
 messaging_status | строка | Текущий статус переписки. Разрешенные значения находятся в справочнике [/dictionaries] (./dictionaries.md) в разделе ```messaging_status```

<a name="hide_message" />
## Скрыть отклик 
Для скрытия отклика необходимо выполнить запрос:

``` 
DELETE /negotiations/active/{nid}
```

где:

 * nid - идентификатор отклика

В качестве ответа придёт HTTP-статус `204 No Content`


<a name="get_messages" />
## Просмотр списка сообщений в отклике

### Запрос

```
GET /negotiations/{nid}/messages
```
где:

 * nid - идентификатор отклика

Опциональные параметры

 Имя | Тип | Обязательный | Описание
 --- | --- | --- | --- 
 page | число | нет | Номер страницы, значение по умолчанию 0
 per_page | число | нет | Количество элементов на страницу, по умолчанию 20
 
### Ответ:

```json
{ 
    "found": 1,
    "pages": 1,
    "per_page": 20,
    "page": 0,
    "items": [
        {
            "id": "123",
            "read": true,
            "created_at" "2013-10-07T18:30:57+0400",
            "text": "Вас приглашает очень крупный иностранный банк на зарплату, о которой мечтают арабские шейхи",
            "state": {
                "id": "invitation",
                "name": "Приглашение"
            },
            "address": null
        }
    ]
}
```

где:

 Имя | Тип  | Описание 
 --- | --- | ---
 found | число | Количество найденных сообщений
 pages | число | Количество найденных страниц с сообщениями
 per_page | число | Количество элементов на страницу
 page | число | Номер текущией страницы (начинается с 0)
 items | массив | Массив сообщений, см. ниже
 
 Отдельное сообщение имеет следующую структуру:
 
 Имя | Тип | Описание
 --- | --- | ---
 id | строка | Идентификатор сообщения
 read | логический | Прочитано ли сообщение принимающей стороной. В запросе редактирования сообщения можно указывать только не прочитанные сообщения. 
 created_at | строка | Дата и время создания сообщения
 text | строка | Текст сообщения
 state | объект | Текущее состояние отклика. Разрешенные значения находятся в справочнике [/dictionaries] (./dictionaries.md) в разделе `negotiations_state`
 address | объект, null | [Адрес] (./address.md), привязанный к отклику/приглашению.
 

<a name='edit_message' />
## Редактирование сообщений в отклике

Если сообщение, адресованное работодателю, ещё не было им прочитано (флаг read в сообщении), то его можно отредактировать.

### Запрос

```
POST /negotiations/{nid}/messages/{mid}
```

где:

 * nid - идентификатор отклика
 * mid - идентификатор сообщения в отклике

Параметры 

 Имя | Обязательный | Описание
 --- | --- | ---
 message | да | Текст сообщения

### Ответ

В случае успешного обновления текста сообщения вернётся HTTP-статус `204 No Content`.
В случае, когда редактирование сообщения запрещено (например, принимающая сторона успела прочитать сообщение) будет возвращён HTTP-статус `403 Forbidden`.
Если сообщение не было найдено, то будет возвращён HTTP-статус `404 Not Found`.

<a name='send_message' />
## Отправка нового сообщения

Отправка нового сообщения работодателю возможна после того, как работодатель пригласил соискателя на вакансию. Сообщения можно отправлять и в случае отказа после собеседования. Если вакансия была отправлена в архив или соискатель удалил резюме, переписка будет недоступна. Работодатель также может вручную отключить переписку для вакансии.

### Запрос

```
POST /negotiations/{nid}/messages
```

где:

 * nid - идентификатор отклика

Параметры

 Имя | Обязательный | Описание
 --- | --- | ---
 message | да | Текст сообщения

### Ответ

В случае успешной отправки сообщения вернётся HTTP-статус `201 Created`.

Если отправить сообщение не удалось, будет возвращён HTTP-статус `400 Bad Request`. 
В теле ответа будет содержаться информацию об ошибке:

```json
{
    "errors": [
        {
            "type": "negotiations_error",
            "value": "in_a_row_limit"
        }
    ]
}
```

При типе ошибки `negotiations_error` `value` может принимать значения аналогичные `messaging_status` 
при [просмотре отклика](#get_negotiation), и еще два дополнительных:
* `empty_message` - при попытке отправить пустое сообщение;
* `too_long_message` - при попытке отправить сообщение, длина которого превышает установленное ограничение.

При отсутствии отклика с таким идентификатором придёт HTTP-статус `404 Not Found` и тип ошибки `not_found`.
